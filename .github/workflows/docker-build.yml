name: Build and Test DAQ System

on:
  push:
    branches: [ main, develop, deploy ]
  pull_request:
    branches: [ main, develop, deploy ]

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  validate-compose:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Validate docker-compose files
      run: |
        cd installer
        docker compose config
        docker compose -f docker-compose.no-slack.yml config

  build-and-push:
    runs-on: ubuntu-latest
    needs: validate-compose
    permissions:
      contents: read
      packages: write

    strategy:
      matrix:
        service: [car-to-influx, slackbot, lappy, startup-data-loader, file-uploader]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Log in to Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Extract metadata
      id: meta
      run: |
        echo "tags=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/${{ matrix.service }}:latest" >> $GITHUB_OUTPUT
        echo "tags=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/${{ matrix.service }}:${{ github.sha }}" >> $GITHUB_OUTPUT

    - name: Build and push Docker image
      uses: docker/build-push-action@v5
      with:
        context: ./installer/${{ matrix.service }}
        push: true
        tags: ${{ steps.meta.outputs.tags }}
        labels: |
          org.opencontainers.image.title=${{ github.event.repository.name }}
          org.opencontainers.image.description=WFR DAQ System - ${{ matrix.service }}
          org.opencontainers.image.url=${{ github.event.repository.html_url }}
          org.opencontainers.image.source=${{ github.event.repository.html_url }}
          org.opencontainers.image.version=${{ github.sha }}
          org.opencontainers.image.created=${{ steps.meta.outputs.created }}
          org.opencontainers.image.revision=${{ github.sha }}

  test-compose:
    runs-on: ubuntu-latest
    needs: build-and-push
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Create .env file for testing
      run: |
        cd installer
        echo "INFLUXDB_TOKEN=test-token-for-ci" > .env

    - name: Pull pre-built images
      run: |
        docker pull influxdb:2
        docker pull grafana/grafana
        docker pull nginx:alpine

    - name: Build test images
      run: |
        cd installer
        docker compose build --parallel

    - name: Validate compose configuration
      run: |
        cd installer
        docker compose config --quiet

    - name: Test container startup (quick smoke test)
      run: |
        cd installer
        # Start only the core services for a quick test
        timeout 30s docker compose up influxdb2 grafana frontend || true
        # Check if containers started (even if they exit quickly)
        docker compose ps

  cleanup:
    runs-on: ubuntu-latest
    needs: [validate-compose, build-and-push, test-compose]
    if: always()
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Clean up Docker resources
      run: |
        docker system prune -f
        docker image prune -f
